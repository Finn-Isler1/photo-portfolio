---
import GalleryItem from "./GalleryItem.astro";
import photoData from "../data/photos.json";

export interface Props {
  columns?: number;
  selectedTags?: string[];
  sortBy?: "name" | "tag" | "id";
}

const { columns = 4, selectedTags = [], sortBy = "name" } = Astro.props;

// Filter by tags if provided
let filteredPhotos =
  selectedTags.length > 0
    ? photoData.filter((item) =>
        selectedTags.some((tag) => item.tags?.includes(tag))
      )
    : photoData;

// Sort by selected method
if (sortBy === "tag") {
  filteredPhotos.sort((a, b) => {
    const aTag = a.tags?.[0] || "";
    const bTag = b.tags?.[0] || "";
    return aTag.localeCompare(bTag);
  });
} else if (sortBy === "name") {
  filteredPhotos.sort((a, b) => a.name.localeCompare(b.name));
} else if (sortBy === "id") {
  filteredPhotos.sort((a, b) => a.id - b.id);
}

// Get unique tags for reference
const allTags = Array.from(
  new Set(photoData.flatMap((item) => item.tags || []))
).sort();
---

<div class="gallery-grid" style={`--columns: ${columns}`}>
  {filteredPhotos.map((item) => <GalleryItem {...item} />)}
</div>

<div id="modal" class="modal">
  <button class="modal-close">&times;</button>
  <div class="modal-content">
    <img id="modal-image" src="" alt="" />
  </div>
  <button class="modal-nav modal-prev">&lt;</button>
  <button class="modal-nav modal-next">&gt;</button>
</div>

<style>
  .gallery-grid {
    column-count: var(--columns, 4);
    column-gap: 1rem;
    padding: 1rem;
  }

  /* column responsive */
  @media (max-width: 1400px) {
    .gallery-grid {
      column-count: 3;
    }
  }

  @media (max-width: 900px) {
    .gallery-grid {
      column-count: 2;
    }
  }

  @media (max-width: 580px) {
    .gallery-grid {
      column-count: 1;
    }
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(233, 233, 233, 0.95);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    max-width: 90%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .modal-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  .modal-content img.fading {
    opacity: 0;
  }

  .modal-close {
    position: absolute;
    top: 0.5rem;
    right: 2rem;
    background: none;
    border: none;
    color: var(--secondary-text-color);
    font-size: 2rem;
    cursor: pointer;
    z-index: 1001;
    line-height: 1;
  }

  .modal-close:hover {
    text-decoration: underline;
  }

  .modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--secondary-text-color);
    font-size: 4rem;
    font-weight: 10;
    cursor: pointer;
    line-height: 1;
  }

  .modal-nav:hover {
    text-decoration: underline;
  }

  .modal-prev {
    left: 1rem;
  }

  .modal-next {
    right: 1rem;
  }
</style>

<script define:vars={{ photoData }}>
  let currentIndex = 0;
  let isTransitioning = false;

  const modal = document.getElementById("modal");
  const modalImage = document.getElementById("modal-image");
  const closeBtn = document.querySelector(".modal-close");
  const prevBtn = document.querySelector(".modal-prev");
  const nextBtn = document.querySelector(".modal-next");

  function openModal(photoId) {
    // Find the photo by ID in the full photoData array
    currentIndex = photoData.findIndex((photo) => photo.id === photoId);
    updateModalContent();
    modal.classList.add("active");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    modal.classList.remove("active");
    document.body.style.overflow = "";
  }

  function updateModalContent(fade = false) {
    if (fade && !isTransitioning) {
      isTransitioning = true;
      modalImage.classList.add("fading");

      setTimeout(() => {
        const item = photoData[currentIndex];
        modalImage.src = `src/photos/${item.path}`;
        modalImage.alt = item.alt;
        modalImage.classList.remove("fading");
        isTransitioning = false;
      }, 300);
    } else if (!fade) {
      const item = photoData[currentIndex];
      modalImage.src = `src/photos/${item.path}`;
      modalImage.alt = item.alt;
    }
  }

  function nextImage() {
    if (isTransitioning) return;
    currentIndex = (currentIndex + 1) % photoData.length;
    updateModalContent(true);
  }

  function prevImage() {
    if (isTransitioning) return;
    currentIndex = (currentIndex - 1 + photoData.length) % photoData.length;
    updateModalContent(true);
  }

  // Event listeners
  document.querySelectorAll(".gallery-item").forEach((item) => {
    const photoId = parseInt(item.getAttribute("data-image-id"), 10);
    item.addEventListener("click", () => openModal(photoId));
  });

  closeBtn.addEventListener("click", closeModal);
  prevBtn.addEventListener("click", prevImage);
  nextBtn.addEventListener("click", nextImage);

  // Close modal on background click
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (!modal.classList.contains("active")) return;

    if (e.key === "Escape") closeModal();
    if (e.key === "ArrowLeft") prevImage();
    if (e.key === "ArrowRight") nextImage();
  });
</script>
